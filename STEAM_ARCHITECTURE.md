# Steam Authentication & Data Fetching Architecture

## Overview

This system uses **ONE server-side Steam API Key** to fetch data for multiple users, each identified by their Steam ID through OpenID login.

### Key Principle
```
API Key ≠ User Identity
API Key = Application Authorization (for rate limits, quotas)
```

---

## Architecture Diagram

```
USER (Browser)
    ↓
    ├─→ [1] "Login with Steam" button
    │   └─→ GET /auth/steam
    │       └─→ Redirect to https://steamcommunity.com/openid/login?...
    │
    ├─→ [2] User logs in on Steam (if needed)
    │   └─→ Steam redirects back to: http://localhost:4000/auth/steam/return?openid..*=...
    │
BACKEND (Node.js/Express)
    ├─→ [3] SteamAuth.verifyAssertion(params)
    │   └─→ Extract steamId from openid.claimed_id (no API Key needed)
    │   └─→ Returns: "76561198000000000" (pure steamid, no secrets)
    │
    ├─→ [4] Find/Create User in Database
    │   └─→ Query: WHERE apiTokens.steamId = ?
    │   └─→ If new user: CREATE with (userId, email, steamId)
    │
    ├─→ [5] Fetch profile from Steam API (optional, non-blocking)\n    │   └─→ SteamService.getPlayerSummaries(steamId)\n    │   └─→ Uses: config.steamApiKey (single server key)\n    │   └─→ Query: GET https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key={API_KEY}&steamids={steamId}\n    │\n    ├─→ [6] Create JWT Token\n    │   └─→ payload: { userId: \"...\", steamId: \"...\", email: \"...\" }\n    │   └─→ sign with config.jwtSecret\n    │   └─→ Expires: 7 days\n    │\n    └─→ [7] Redirect to frontend with token\n        └─→ GET http://localhost:3000/auth/callback?token={JWT}\n\nFRONTEND (Next.js)\n    ├─→ [8] Store token in localStorage + cookie\n    │   └─→ localStorage.setItem('auth_token', token)\n    │   └─→ Set cookie: auth_token={token}; path=/; max-age=604800\n    │\n    └─→ [9] Include token in all API requests\n        └─→ fetch('/api/dashboard', {\n            headers: { 'Authorization': `Bearer ${token}` }\n          })\n\nBACKEND (subsequent requests)\n    └─→ [10] Middleware validates JWT\n        ├─→ Extract token from Authorization header\n        ├─→ Verify signature with config.jwtSecret\n        ├─→ Extract userId + steamId from payload\n        └─→ Attach to req.user = { id: userId, email, steamId }\n\n        [11] Controller uses userId + steamId\n        └─→ DashboardController.get(req)\n            ├─→ userId = req.user.id\n            ├─→ steamId = req.user.steamId (optional, for logging)\n            └─→ DashboardService.getDashboard(userId)\n                └─→ Query games for that userId ONLY\n```\n\n---\n\n## Step-by-Step Flow\n\n### 1. OpenID Login (No API Key Involved)\n\n```typescript\n// apps/api/src/auth/steam-openid.ts\n\ngetRedirectUrl(): string {\n  // Generate Steam login URL\n  return `https://steamcommunity.com/openid/login?openid.ns=...&openid.realm=...`\n}\n\nasync verifyAssertion(params): Promise<string | null> {\n  // Steam redirects back with openid.* query params\n  // Extract steamId from openid.claimed_id\n  // NO API Key used here\n  return steamId; // e.g., \"76561198000000000\"\n}\n```\n\n### 2. User Registration/Update\n\n```typescript\n// apps/api/src/routes/index.ts - /auth/steam/return\n\nconst steamId = await steamAuth.verifyAssertion(req.query);\n\n// Find or create user\nlet user = await prisma.user.findFirst({\n  where: { apiTokens: { steamId } }\n});\n\nif (!user) {\n  user = await prisma.user.create({\n    data: {\n      email: `${steamId}@steam.local`,\n      apiTokens: { create: { steamId } } // Store steamId for later API calls\n    }\n  });\n}\n```\n\n### 3. Fetch User Profile (Uses API Key)\n\n```typescript\n// apps/api/src/services/steam-service.ts\n\nstatic async getPlayerSummaries(steamId: string) {\n  // Uses the SERVER's SINGLE API Key\n  const key = config.steamApiKey; // From env: STEAM_API_KEY=...\n  \n  const url = `https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/\n    ?key=${key}\n    &steamids=${steamId}`; // <-- This steamId identifies WHICH user's data\n  \n  const { data } = await axios.get(url);\n  return data.response.players[0]; // User's profile data\n}\n```\n\n**Key point:** The API Key is in the URL for authorization. The `steamids` parameter identifies whose data to fetch.\n\n### 4. Create JWT Token\n\n```typescript\n// apps/api/src/utils/jwt.ts\n\nconst token = signToken({\n  userId: user.id,      // Our app's user ID\n  email: user.email,\n  steamId: steamId      // Their Steam ID (for reference)\n});\n\n// Token is signed with config.jwtSecret (server-only secret)\n// Token does NOT contain the API Key\n```\n\n### 5. Frontend Stores Token\n\n```typescript\n// apps/web/app/auth/callback/page.tsx\n\nuseEffect(() => {\n  const token = searchParams.get('token');\n  if (token) {\n    localStorage.setItem('auth_token', token);\n    document.cookie = `auth_token=${token}; path=/; max-age=604800`;\n  }\n});\n```\n\n### 6. Subsequent Requests Include Token\n\n```typescript\n// apps/web/lib/api.ts or app/page.tsx\n\nconst token = localStorage.getItem('auth_token');\nconst res = await fetch('/dashboard', {\n  headers: {\n    'Authorization': `Bearer ${token}` // <-- Token in header\n  }\n});\n```\n\n### 7. Backend Validates Token & Fetches Data\n\n```typescript\n// apps/api/src/routes/index.ts\n\nrouter.get('/dashboard', authMiddleware, async (req, res) => {\n  // authMiddleware validates JWT and sets req.user\n  const userId = req.user.id;    // From token\n  const steamId = req.user.steamId; // From token (optional)\n  \n  // Fetch data for THIS user only\n  const data = await DashboardService.getDashboard(userId);\n  res.json(data);\n});\n```\n\n```typescript\n// apps/api/src/services/dashboard-service.ts\n\nstatic async getDashboard(userId: string) {\n  // Query ONLY this user's games\n  const user = await prisma.user.findUnique({\n    where: { id: userId },\n    include: { userGames: true }\n  });\n  \n  // Return data for this user ONLY\n  return {\n    playtime: {\n      totalHours: user.userGames.reduce((sum, ug) => sum + ug.hours, 0),\n      // ... more data\n    }\n  };\n}\n```\n\n---\n\n## Per-User Data Isolation\n\n### Database Structure\n\n```\nUser (id=user1, email=76561198000000000@steam.local)\n  ├─ ApiToken (steamId=76561198000000000)\n  └─ UserGame[] (games owned by this user)\n\nUser (id=user2, email=76561198111111111@steam.local)\n  ├─ ApiToken (steamId=76561198111111111)\n  └─ UserGame[] (games owned by this user)\n```\n\n### Query Guarantee\n\n```typescript\n// CORRECT: Uses userId from JWT token\nawait prisma.userGame.findMany({\n  where: { userId: req.user.id } // req.user.id from verified token\n});\n\n// WRONG: Using steamId as user identifier (security risk)\nawait prisma.userGame.findMany({\n  where: { steamId: req.body.steamId } // User controls this!\n});\n```\n\n---\n\n## Environment Variables\n\n```bash\n# .env\nPORT=4000\nDATABASE_URL=\"postgresql://...\" # Your database\nJWT_SECRET=\"dev-secret-change-in-production\" # Sign JWT tokens\n\nSTEAM_API_KEY=\"CBB540065CB5FF3DBD3B1CD2EFD39CFE\" # Single server key\n# This key:\n# - Authenticates API requests to Steam\n# - Does NOT identify a user\n# - Should NOT be shared with frontend\n\nNEXT_PUBLIC_API_BASE_URL=\"http://localhost:4000\" # Public API URL\n```\n\n---\n\n## Error Handling\n\n### Profile is Private\n\n```typescript\nconst summary = await SteamService.getPlayerSummaries(steamId);\nif (!summary) {\n  // Profile is private or Steam API is down\n  // LOGIN STILL SUCCEEDS\n  // We use default avatar/name\n  console.warn('Profile unavailable');\n  displayName = `Player_${steamId.slice(-6)}`;\n}\n```\n\n### Invalid API Key\n\n```typescript\n// If STEAM_API_KEY is wrong, Steam returns 403 or 401\ntry {\n  const games = await SteamService.getOwnedGames(steamId);\n} catch (err) {\n  if (err.response?.status === 401) {\n    console.error('API Key invalid or revoked');\n    // Admin must fix .env\n  }\n}\n```\n\n### User Provides Wrong steamId\n\n```typescript\n// Frontend should NEVER send steamId in request body\n// Only backend generates/validates steamId via OpenID\n\n// WRONG:\nPOST /api/games\nBody: { steamId: \"76561198111111111\" } // User spoofing\n\n// CORRECT:\nGET /api/games\nHeader: Authorization: Bearer {jwt_token}\n// Backend extracts userId from token, queries their games only\n```\n\n---\n\n## Security Checklist\n\n- [x] API Key stored in `.env`, never sent to frontend\n- [x] API Key is application auth, not user auth\n- [x] JWT token identifies logged-in user, expires in 7 days\n- [x] Token signature verified server-side with config.jwtSecret\n- [x] All data queries use `userId` from token, not from request body\n- [x] Per-user dumps (`steam_dump_<userId>.json`) prevent cross-user data\n- [x] Middleware checks for valid token on protected routes\n- [x] OpenID response verified cryptographically with Steam\n\n---\n\n## Testing the Flow\n\n### 1. Start the application\n```bash\nnpm run dev\n```\n\n### 2. Click \"Login with Steam\"\nYou'll be redirected to: `https://steamcommunity.com/openid/login?...`\n\n### 3. Steam redirects back to\n`http://localhost:4000/auth/steam/return?openid.claimed_id=...&openid.mode=id_res`\n\n### 4. Backend logs\n```\n[OpenID] Successfully verified steamid: 76561198000000000\n[Auth] ✓ Verified steamId: 76561198000000000\n[Auth] Creating new user for steamId: 76561198000000000\n[Auth] ✓ Login complete for userId: abc123, steamId: 76561198000000000\n```\n\n### 5. Frontend receives\n`GET http://localhost:3000/auth/callback?token=eyJhbGc...`\n\n### 6. Check localStorage\n```javascript\nconst token = localStorage.getItem('auth_token');\nconsole.log(JSON.parse(atob(token.split('.')[1]))); \n// {\n//   userId: \"abc123\",\n//   steamId: \"76561198000000000\",\n//   email: \"76561198000000000@steam.local\",\n//   iat: 1702388400,\n//   exp: 1703080400\n// }\n```\n\n### 7. Request dashboard\n```bash\ncurl -H \"Authorization: Bearer {token}\" http://localhost:4000/dashboard\n```\n\nShould return that user's stats ONLY.\n\n---\n\n## FAQ\n\n**Q: Can a user see another user's stats?**\n\nA: No. The JWT token contains `userId`, and all data queries filter by that userId. Even if someone guesses another user's steamId, without the correct JWT token, they can't access any endpoint.\n\n**Q: Does the API Key identify the user?**\n\nA: No. The API Key authenticates the application to Steam (proves our app is registered). The `steamid` parameter in API calls specifies whose data to fetch. The user is identified by the JWT token on the backend.\n\n**Q: What if someone steals the API Key?**\n\nA: They can make API calls to Steam on your behalf, but they still can't see user data from your database without the JWT token. They also can't spoof a JWT because it's signed with your secret.\n\n**Q: Can I use user-specific API Keys?**\n\nA: Steam doesn't issue per-user API Keys. The Web API Key is application-level. For user-specific auth, Steam uses OpenID (what we're using) or OAuth (not available for personal apps).\n\n---\n\n## Implementation Checklist\n\n- [x] `steam-openid.ts` - Extracts steamId from OpenID response\n- [x] `steam-service.ts` - Fetches Steam data using server API Key\n- [x] `jwt.ts` - Signs/verifies tokens containing userId + steamId\n- [x] `/auth/steam` - Initiates OpenID login\n- [x] `/auth/steam/return` - Handles OpenID callback, creates token\n- [x] `/dashboard` - Protected route using authMiddleware + userId\n- [x] `dashboard-service.ts` - Queries DB by userId only\n- [x] `app/page.tsx` - SSR uses cookies to fetch /dashboard with auth header\n- [x] Per-user dumps - `steam_dump_<userId>.json` prevents data mixing\n\n---\n\n## Next Steps\n\n1. Kill any old API processes:\n   ```bash\n   # PowerShell\n   Get-NetTCPConnection -LocalPort 4000 | Select-Object OwningProcess | % { taskkill /PID $_.OwningProcess /F }\n   ```\n\n2. Restart the dev server:\n   ```bash\n   npm run dev\n   ```\n\n3. Test with a friend's Steam account:\n   - Friend logs in → Gets their own token\n   - Friend should see ONLY their games\n   - You should not see friend's stats when logged in\n\n4. Monitor logs for per-user data isolation:\n   ```\n   [Auth] Creating new user for steamId: FRIEND_STEAM_ID\n   [SyncService] Syncing Steam library for user FRIEND_USER_ID\n   [Dashboard] Loaded for user FRIEND_USER_ID: 50 games, 1200 hours\n   ```\n"